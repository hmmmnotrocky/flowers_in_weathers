---
import Layout from '../layouts/Layout.astro';
import Pot from '../components/Pot.astro';
---


<Layout>
  <div class="page">

    <div class="grid">

      <!-- Row 1 -->
      <div class="cell">1</div>

		<div class="cell day-selector">
		<div class="sf-clock" id="sf-clock">
			Loading SF time...
		</div>

		<div class="days">
			<button data-day="0">1</button>
			<button data-day="1">2</button>
			<button data-day="2">3</button>
			<button data-day="3">4</button>
			<button data-day="4">5</button>
			<button data-day="5">6</button>
			<button data-day="6">7</button>
		</div>
		</div>


      <div class="cell">3</div>

      <!-- Row 2 -->
		<div class="cell hour-panel" id="hour-panel">
		<div class="hour-slider-container">
			<input 
			type="range" 
			min="0" 
			max="23" 
			step="1"
			id="hour-slider"
			/>
		</div>

		<div class="hour-details" id="hour-details">
			Select a day
		</div>
		
		</div>
	
		<div class="cell cloud-cell" id="cloud-cell">
		<Pot />
		</div>





		<div class="cell center" id="details-cell">
		Select a day
		</div>



      <!-- Row 3 -->
      <div class="cell">7</div>
      <div class="cell">8</div>
      <div class="cell">9</div>

    </div>

  </div>
</Layout>

<script>
let weatherData = null;
let currentDayIndex = 0;
let currentDayIndices = [];
let baseAmplitude = 0;      // degrees
let baseFrequency = 0.5;    // radians/sec
let gustBoost = 1;          // multiplier


async function loadWeather() {
  const url =
    "https://api.open-meteo.com/v1/forecast?" +
    "latitude=37.7749" +
    "&longitude=-122.4194" +
    "&hourly=temperature_2m,relativehumidity_2m,apparent_temperature,precipitation,cloudcover,windspeed_10m,windgusts_10m" +
    "&daily=temperature_2m_max,temperature_2m_min" +
    "&timezone=auto";

  const res = await fetch(url);
  weatherData = await res.json();
}

/* ---------- DAILY SUMMARY ---------- */

function getUniqueDates() {
  return [...new Set(
    weatherData.hourly.time.map(t => t.split("T")[0])
  )];
}

function computeDayIndices(dayIndex) {
  const hourly = weatherData.hourly;
  const uniqueDates = getUniqueDates();
  const selectedDate = uniqueDates[dayIndex];

  currentDayIndices = hourly.time
    .map((t, i) => ({ time: t, index: i }))
    .filter(obj => obj.time.startsWith(selectedDate))
    .map(obj => obj.index);

  return selectedDate;
}

function minMax(array) {
  const values = currentDayIndices.map(i => array[i]);
  return {
    min: Math.min(...values),
    max: Math.max(...values)
  };
}

function displayDay(dayIndex) {
  currentDayIndex = dayIndex;
  const selectedDate = computeDayIndices(dayIndex);

  const formattedDate = new Date(selectedDate).toLocaleDateString(
    "en-US",
    {
      weekday: "long",
      year: "numeric",
      month: "long",
      day: "numeric"
    }
  );

  const h = weatherData.hourly;

  const summaryHTML = `
    <div>
      <h3>${formattedDate}</h3>
      <p>Temperature: ${minMax(h.temperature_2m).min}°C → ${minMax(h.temperature_2m).max}°C</p>
      <p>Humidity: ${minMax(h.relativehumidity_2m).min}% → ${minMax(h.relativehumidity_2m).max}%</p>
      <p>Precipitation: ${minMax(h.precipitation).min} → ${minMax(h.precipitation).max} mm</p>
      <p>Cloud Cover: ${minMax(h.cloudcover).min}% → ${minMax(h.cloudcover).max}%</p>
      <p>Wind Speed: ${minMax(h.windspeed_10m).min} → ${minMax(h.windspeed_10m).max} km/h</p>
      <p>Wind Gusts: ${minMax(h.windgusts_10m).min} → ${minMax(h.windgusts_10m).max} km/h</p>
    </div>
  `;

  document.getElementById("details-cell").innerHTML = summaryHTML;

  initializeSliderToCurrentHour();
}

/* ---------- HOURLY SLIDER ---------- */

function initializeSliderToCurrentHour() {
  const slider = document.getElementById("hour-slider");

  const now = new Date();
  const sfHour = new Intl.DateTimeFormat("en-US", {
    timeZone: weatherData.timezone,
    hour: "numeric",
    hour12: false
  }).format(now);

  slider.value = parseInt(sfHour);
  renderHour(parseInt(slider.value));
}

function renderHour(hourWithinDay) {
  const hourly = weatherData.hourly;
  const realIndex = currentDayIndices[hourWithinDay];

  if (realIndex === undefined) return;

  const cloud = hourly.cloudcover[realIndex];


	const wind = hourly.windspeed_10m[realIndex];
	const gust = hourly.windgusts_10m[realIndex];

	const maxWind = 40;

	// --- Base amplitude (0–30 degrees)
	baseAmplitude = Math.min((wind / maxWind) * 30, 30);

	// --- Base frequency (slow when calm, faster when windy)
	const minFreq = 0.3;   // calm
	const maxFreq = 1.2;   // strong wind
	baseFrequency = minFreq + (wind / maxWind) * (maxFreq - minFreq);

	// --- Gust boost (temporary energy injection)
	gustBoost = gust > wind ? gust / wind : 1;


  // Update cloud cell opacity
  const cloudCell = document.getElementById("cloud-cell");
  cloudCell.style.backgroundColor = `rgba(255, 218, 185, ${cloud / 100})`;


  const html = `
    <div>
      <h4>${hourly.time[realIndex]}</h4>
      <p>Temp: ${hourly.temperature_2m[realIndex]}°C</p>
      <p>Feels: ${hourly.apparent_temperature[realIndex]}°C</p>
      <p>Humidity: ${hourly.relativehumidity_2m[realIndex]}%</p>
      <p>Precipitation: ${hourly.precipitation[realIndex]} mm</p>
      <p>Cloud Cover: ${cloud}%</p>
      <p>Wind Speed: ${hourly.windspeed_10m[realIndex]} km/h</p>
      <p>Wind Gusts: ${hourly.windgusts_10m[realIndex]} km/h</p>
    </div>
  `;

  document.getElementById("hour-details").innerHTML = html;
}


/* ---------- LIVE SF CLOCK ---------- */

function startSFClock(timezone) {
  const clockEl = document.getElementById("sf-clock");

  function updateClock() {
    const now = new Date();

    const formatted = now.toLocaleString("en-US", {
      timeZone: timezone,
      weekday: "short",
      year: "numeric",
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit"
    });

    clockEl.textContent = formatted + " (SF)";
  }

  updateClock();
  setInterval(updateClock, 1000);
}

let startTime = null;

function animateSway(timestamp) {
  if (!startTime) startTime = timestamp;

  const elapsed = (timestamp - startTime) / 1000;

  // Smooth decay of gust effect
  gustBoost += (1 - gustBoost) * 0.02;

  const amplitude = baseAmplitude * gustBoost;
  const frequency = baseFrequency * (1 + 0.2 * (gustBoost - 1));
  const phase = Math.random() * Math.PI * 2;
  const angle = amplitude * Math.sin(frequency * elapsed + phase);

	document.querySelectorAll(".sway-group").forEach(group => {
	const phase = parseFloat(group.dataset.phase);
	const angle = amplitude * Math.sin(frequency * elapsed + phase);
	group.style.transform = `rotate(${angle}deg)`;
	});


  requestAnimationFrame(animateSway);
}

requestAnimationFrame(animateSway);


/* ---------- INIT ---------- */

document.addEventListener("DOMContentLoaded", async () => {
  await loadWeather();
  startSFClock(weatherData.timezone);

  const buttons = document.querySelectorAll(".days button");
  const slider = document.getElementById("hour-slider");

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const dayIndex = parseInt(btn.dataset.day);
      displayDay(dayIndex);
    });
  });

  slider.addEventListener("input", (e) => {
    renderHour(parseInt(e.target.value));
  });

  // Auto select day 1
  buttons[0].click();
});
</script>



<style>
  * {
    box-sizing: border-box;
  }

	.cell.cloud-cell {
	display: flex;
	justify-content: center;
	align-items: flex-end;
	transition: background-color 0.3s ease;
	padding-bottom: 1rem;
	}

	.pot-container {
	width: 60%;
	max-width: 220px;
	}

	.pot-svg {
	width: 100%;
	height: auto;
	color: #444;
	}
  
  
	.hour-panel {
	display: flex;
	width: 100%;
	height: 100%;
	}

	.hour-slider-container {
	width: 30%;
	display: flex;
	justify-content: center;
	align-items: center;
	}

	.hour-slider-container input[type="range"] {
	writing-mode: bt-lr; /* vertical */
	-webkit-appearance: slider-vertical;
	height: 80%;
	}

	.hour-details {
	width: 70%;
	padding: 1rem;
	font-size: 0.85rem;
	overflow-y: auto;
	}
  

	.day-selector {
	padding: 1rem;
	flex-direction: column;
	}

	.sf-clock {
	font-size: 0.9rem;
	margin-bottom: 1rem;
	text-align: center;
	font-weight: 500;
	}

	.days {
	display: grid;
	grid-template-columns: repeat(4, 1fr);
	gap: 0.5rem;
	}

	.days button {
	padding: 0.75rem;
	border: 1px solid #ddd;
	background: white;
	cursor: pointer;
	}

	.days button.active {
	background: #eee;
	}


  body {
    margin: 0;
  }

  .page {
    min-height: 100vh;
  }

  .grid {
    display: grid;
    height: 100vh;

    /* 3 columns */
    grid-template-columns: 1fr 1fr 1fr;

    /* 3 rows */
    grid-template-rows: 1fr 2fr 1fr;
  }

  .cell {
    border: 1px solid #eee;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .center {
    background: #f4f4f4;
  }

  .pot {
    width: 70%;
    min-width: 120px;
    height: 100%;
    background: #ddd;
    border-radius: 12px;

    display: flex;
    justify-content: center;
    align-items: center;

    font-size: 2rem;
  }
</style>
